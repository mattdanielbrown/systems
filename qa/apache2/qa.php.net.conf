#
# Edit this file in https://github.com/php/systems repo!
#

#
# qa.php.net: not fronted by Myra so we have to deal with SSL
# slated for removal in the not-too-distant future (as of August 2024)
#
<VirtualHost *:80>
    ServerName qa.php.net
    Redirect / https://qa.php.net/
</VirtualHost>

<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerAdmin systems@php.net
    ServerName qa.php.net

    DocumentRoot /var/www/qa.php.net

    RewriteEngine on
    # Outdated reports that are just used by scrapers
    RewriteRule ^/build.php - [F]
    RewriteRule ^/reports/details - [F]
    RewriteRule ^/reports/run_tests - [F]
    RewriteRule ^/reports/viewreports - [F]
    RewriteRule ^/buildtest-submit.php - [F]

    # Redirect content to new location
    RewriteRule ^/$                   https://php.net/release-candidates.php
    RewriteRule ^/expectf_details.php https://php.github.io/php-src/miscellaneous/writing-tests.html#id4 [NE]
    RewriteRule ^/handling-bugs.php   https://github.com/php/php-src/issues/new/choose
    RewriteRule ^/howtohelp.php       https://php.github.io/php-src/miscellaneous/writing-tests.html
    RewriteRule ^/howto_phpt.php      https://php.github.io/php-src/miscellaneous/writing-tests.html
    RewriteRule ^/howto_phpunit.php   https://php.github.io/php-src/miscellaneous/writing-tests.html
    RewriteRule ^/list_builds.php     https://github.com/php/php-src/actions
    RewriteRule ^/pftt.php            https://github.com/php/php-src/actions
    RewriteRule ^/phpt_details.php    https://php.github.io/php-src/miscellaneous/writing-tests.html#phpt-structure-details [NE]
    RewriteRule ^/projects            https://www.php.net/release-candidates.php
    RewriteRule ^/rc                  https://www.php.net/release-candidates.php
    RewriteRule ^/running-tests.php   https://php.github.io/php-src/miscellaneous/running-tests.html
    RewriteRule ^/write-test.php      https://php.github.io/php-src/miscellaneous/writing-tests.html
    RewriteRule ^/sample_tests        https://php.github.io/php-src/miscellaneous/writing-tests.html#samples [NE]

    # API Requests
    RewriteCond %{QUERY_STRING} ^type=qa-releases$
    RewriteRule ^/api.php$      https://www.php.net/release-candidates.php?format=serialize

    RewriteCond %{QUERY_STRING} ^type=qa-releases&format=serialise$
    RewriteRule ^/api.php$      https://www.php.net/release-candidates.php?format=serialize

    RewriteCond %{QUERY_STRING} ^type=qa-releases&format=json$
    RewriteRule ^/api.php$      https://www.php.net/release-candidates.php?format=json

    RewriteCond %{QUERY_STRING} ^type=qa-releases&format=json&only=dev_versions$
    RewriteRule ^/api.php$      https://www.php.net/release-candidates.php?format=json&only=dev_versions

    RewriteRule ^/api.php$      https://www.php.net/release-candidates.php

    # 403 Everything else besides robots.txt
    RewriteCond %{REQUEST_URI} !^/robots.txt
    RewriteRule ^/ - [F]

    <Directory />
        Options FollowSymLinks
        AllowOverride None
    </Directory>

    <Directory /var/www/qa.php.net/>
        Options Indexes FollowSymLinks MultiViews
        AllowOverride None
        Order allow,deny
        allow from all
    </Directory>

    <Directory ~ "\.svn">
        Order allow,deny
        Deny from all
    </Directory>

    <Directory ~ "\.git">
        Order allow,deny
        Deny from all
    </Directory>

    <Directory "/var/www/qa.php.net/reports/db">
        Options -Indexes
        Order deny,allow
        deny from all
    </Directory>

    <FilesMatch "\.(sqlite|cache)$">
        Require all denied
    </FilesMatch>

    ErrorLog ${APACHE_LOG_DIR}/qa.php.net-error.log
    CustomLog ${APACHE_LOG_DIR}/qa.php.net-access.log combined
    LogLevel warn

    # This sets SSLEngine on, sets protocol and cipher suite stuff
    Include /etc/letsencrypt/options-ssl-apache.conf
    SSLCertificateFile /etc/letsencrypt/live/qa.php.net/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/qa.php.net/privkey.pem

    # AUTH_TOKEN, USER_TOKEN, and USER_PWD_SALT are set here
    Include /local/this-box/apache.conf
</VirtualHost>
</IfModule>
